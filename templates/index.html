<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√®o Scraper Pro - Render Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        .log-line { border-bottom: 1px solid #333; padding: 4px 0; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6">
        <h1 class="text-2xl font-bold text-blue-400 mb-4">ü§ñ T√®o Scraper (AI + Anti-Cloudflare)</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="md:col-span-2">
                <label class="text-xs font-bold text-gray-400">User-Agent (B·∫Øt bu·ªôc)</label>
                <input type="text" id="user_agent" class="w-full p-2 bg-gray-700 rounded text-xs text-yellow-300" placeholder="Paste User-Agent...">
            </div>
            <div class="md:col-span-2">
                <label class="text-xs font-bold text-gray-400">Cookie (N·∫øu web ch·∫∑n)</label>
                <textarea id="cookie_str" class="w-full h-12 p-2 bg-gray-700 rounded text-xs text-green-300" placeholder="Paste Cookie..."></textarea>
            </div>
        </div>

        <div class="border-t border-gray-700 pt-4 mb-4">
            <label class="block text-sm font-bold mb-1">Link Truy·ªán (Trang m·ª•c l·ª•c)</label>
            <div class="flex gap-2">
                <input type="text" id="story_url" class="flex-1 p-2 rounded bg-gray-700" placeholder="https://metruyencv.com/truyen/...">
                <button onclick="getChapters()" id="btn-get" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">
                    üîç L·∫•y DS
                </button>
            </div>
            <div id="chapter_info" class="text-sm text-green-400 mt-2 hidden">
                ‚úÖ T√¨m th·∫•y <span id="total_chapters" class="font-bold">0</span> ch∆∞∆°ng.
            </div>
        </div>

        <div id="step-2" class="border-t border-gray-700 pt-4 mb-4 hidden opacity-50 pointer-events-none">
            <div class="flex gap-4 items-end">
                <div>
                    <label class="text-xs">T·ª´ ch∆∞∆°ng (Index)</label>
                    <input type="number" id="start_idx" class="w-24 p-2 bg-gray-700 rounded" value="1">
                </div>
                <div>
                    <label class="text-xs">ƒê·∫øn ch∆∞∆°ng (Index)</label>
                    <input type="number" id="end_idx" class="w-24 p-2 bg-gray-700 rounded" value="5">
                </div>
                <button onclick="startScrape()" id="btn-run" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded font-bold">
                    üöÄ CH·∫†Y NGAY ƒêI
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">L∆∞u √Ω: Render Free ch·∫°y ch·∫≠m, n√™n c√†o m·ªói l·∫ßn kho·∫£ng 10-20 ch∆∞∆°ng th√¥i nh√©.</p>
        </div>

        <div class="mt-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold">üì∫ Ti·∫øn ƒë·ªô & K·∫øt qu·∫£</h3>
                <button onclick="downloadTxt()" id="btn-down" class="hidden bg-green-600 px-3 py-1 rounded text-sm">
                    üíæ T·∫£i file .txt
                </button>
            </div>
            <div id="logs" class="h-64 bg-black p-4 rounded overflow-y-auto font-mono text-xs text-gray-300 border border-gray-700">
                <p class="text-gray-500 italic">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o...</p>
            </div>
        </div>
    </div>

    <script>
        let allChapters = [];
        let scrapedContent = [];

        function log(msg, color = 'text-gray-300') {
            const logs = document.getElementById('logs');
            logs.innerHTML += `<div class="log-line ${color}">${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        async function getChapters() {
            const url = document.getElementById('story_url').value;
            const ua = document.getElementById('user_agent').value;
            const ck = document.getElementById('cookie_str').value;
            
            if(!url || !ua) return alert("Nh·∫≠p Link v√† User-Agent!");

            log("üîÑ ƒêang qu√©t danh s√°ch ch∆∞∆°ng...", "text-blue-400");
            document.getElementById('btn-get').disabled = true;

            try {
                const res = await fetch('/get_chapters', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({story_url: url, user_agent: ua, cookie_str: ck})
                });
                const data = await res.json();
                
                if(data.error) {
                    log("‚ùå L·ªói: " + data.error, "text-red-500");
                } else {
                    allChapters = data.chapters;
                    document.getElementById('total_chapters').innerText = data.count;
                    document.getElementById('chapter_info').classList.remove('hidden');
                    
                    // M·ªü b∆∞·ªõc 2
                    const step2 = document.getElementById('step-2');
                    step2.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                    document.getElementById('end_idx').value = Math.min(5, data.count); // M·∫∑c ƒë·ªãnh 5 ch∆∞∆°ng
                    
                    log(`‚úÖ ƒê√£ t·∫£i xong ${data.count} ch∆∞∆°ng.`, "text-green-400");
                }
            } catch(e) {
                log("‚ùå L·ªói m·∫°ng: " + e, "text-red-500");
            } finally {
                document.getElementById('btn-get').disabled = false;
            }
        }

        async function startScrape() {
            const start = parseInt(document.getElementById('start_idx').value) - 1;
            const end = parseInt(document.getElementById('end_idx').value);
            const ua = document.getElementById('user_agent').value;
            const ck = document.getElementById('cookie_str').value;

            if(start < 0 || end > allChapters.length || start >= end) {
                return alert("S·ªë ch∆∞∆°ng kh√¥ng h·ª£p l·ªá!");
            }

            // L·∫•y danh s√°ch link c·∫ßn c√†o
            const targets = allChapters.slice(start, end).map(c => c.url);
            scrapedContent = []; // Reset k·∫øt qu·∫£

            document.getElementById('btn-run').disabled = true;
            log(`üöÄ B·∫Øt ƒë·∫ßu c√†o t·ª´ ch∆∞∆°ng ${start + 1} ƒë·∫øn ${end}...`, "text-yellow-400");

            try {
                const response = await fetch('/stream_scrape', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chapter_urls: targets,
                        user_agent: ua,
                        cookie_str: ck
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const json = JSON.parse(line);
                            if(json.status === 'progress') {
                                log(json.msg, "text-blue-300");
                            } else if(json.status === 'data') {
                                log(`‚úÖ Xong: ${json.url}`, "text-green-400");
                                scrapedContent.push(`\n\n--- CH∆Ø∆†NG ${json.chapter_index + 1 + start} ---\n` + json.content);
                            } else if(json.status === 'done') {
                                log("üéâ HO√ÄN T·∫§T!", "text-purple-400");
                                document.getElementById('btn-down').classList.remove('hidden');
                            }
                        } catch(e) {}
                    }
                }

            } catch(e) {
                log("‚ùå L·ªói khi ch·∫°y: " + e, "text-red-500");
            } finally {
                document.getElementById('btn-run').disabled = false;
            }
        }

        function downloadTxt() {
            if(scrapedContent.length === 0) return alert("Ch∆∞a c√≥ n·ªôi dung!");
            const blob = new Blob(scrapedContent, { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "truyen_convert_teo.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
